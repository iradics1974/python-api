name: Build and Push Docker Image
# This workflow builds your Docker image and pushes it to Docker Hub
# every time you push code to the main branch.

on:
  push:
    branches:
      - main        # Trigger workflow only on changes to the main branch

jobs:
  build:
    runs-on: ubuntu-latest    # Run this job on a GitHub-hosted Linux VM

    steps:

    # --- Step 1: Download the project code into the runner ---
    - name: Checkout repository
      uses: actions/checkout@v4

    # --- Step 2: Log in to Docker Hub using secrets ---
    # These secrets must be added in GitHub:
    # DOCKERHUB_USERNAME
    # DOCKERHUB_TOKEN
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # --- Step 3: Extract short git commit SHA (first 7 characters) ---
    # This will become the version tag for the Docker image.
    - name: Extract short SHA
      id: vars
      run: echo "SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV

    # --- Step 4: Build Docker image ---
    # Two tags:
    #   latest       → Always the newest build
    #   <short-sha>  → Unique tag for Image Updater to detect
    - name: Build Docker image with SHA and latest tags
      run: |
        IMAGE=iradics1974/python-api
        docker build \
          -t $IMAGE:latest \
          -t $IMAGE:${SHORT_SHA} \
          .

    # --- Step 5: Push both Docker image tags to Docker Hub ---
    # This gives:
    #  iradics1974/python-api:latest
    #  iradics1974/python-api:<short-sha>
    - name: Push all tags
      run: |
        IMAGE=iradics1974/python-api
        docker push $IMAGE:latest
        docker push $IMAGE:${SHORT_SHA}

    # --- Step 6: Print summary in the GitHub Actions log ---
    - name: Print pushed image tags
      run: |
        echo "Pushed tags:"
        echo " - latest"
        echo " - ${SHORT_SHA}"
